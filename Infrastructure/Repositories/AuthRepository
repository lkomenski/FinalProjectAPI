using FinalProjectAPI.Infrastructure.Interfaces;
using FinalProjectAPI.Models;

namespace FinalProjectAPI.Repositories
{
    public class AuthRepository : IAuthRepository
    {
        private readonly SqlDataRepository _sqlData;

        public AuthRepository(SqlDataRepository sqlData)
        {
            _sqlData = sqlData;
        }

        public async Task<Customer?> LoginAsync(string email, string password)
        {
            var parameters = new Dictionary<string, object?>
            {
                { "@EmailAddress", email },
                { "@Password", password }
            };

            var results = await _sqlData.GetDataAsync("CustomerLogin", parameters);
            var row = results.FirstOrDefault();

            if (row == null) return null;

            return new Customer
            {
                CustomerID = Convert.ToInt32(row["CustomerID"]),
                EmailAddress = row["EmailAddress"]?.ToString() ?? "",
                FirstName = row["FirstName"]?.ToString() ?? "",
                LastName = row["LastName"]?.ToString() ?? "",
                ShippingAddressID = Convert.ToInt32(row["ShippingAddressID"]),
                BillingAddressID = Convert.ToInt32(row["BillingAddressID"])
            };
        }

        public async Task<Customer?> RegisterAsync(Customer customer)
        {
            var parameters = new Dictionary<string, object?>
            {
                { "@EmailAddress", customer.EmailAddress },
                { "@Password", customer.Password },
                { "@FirstName", customer.FirstName },
                { "@LastName", customer.LastName },
                { "@ShippingAddressID", customer.ShippingAddressID },
                { "@BillingAddressID", customer.BillingAddressID }
            };

            var results = await _sqlData.GetDataAsync("CustomerRegister", parameters);
            var row = results.FirstOrDefault();
            if (row == null) return null;

            return new Customer
            {
                CustomerID = Convert.ToInt32(row["CustomerID"]),
                EmailAddress = row["EmailAddress"]?.ToString() ?? "",
                FirstName = row["FirstName"]?.ToString() ?? "",
                LastName = row["LastName"]?.ToString() ?? ""
            };
        }

        public async Task<bool> CustomerExistsAsync(string email)
        {
            var parameters = new Dictionary<string, object?>
            {
                { "@EmailAddress", email }
            };

            var results = await _sqlData.GetDataAsync("CheckCustomerExists", parameters);
            var row = results.FirstOrDefault();
            return row != null && Convert.ToBoolean(row["Exists"]);
        }
    }
}
